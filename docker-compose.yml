version: '3.8'

services:
  wolf-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: wolf-project:latest
    container_name: wolf-server
    restart: unless-stopped
    ports:
      - "7171:7171"  # Game port
      - "7172:7172"  # Login port
    volumes:
      - ./config.lua:/srv/config.lua:ro
      - ./data:/srv/data:ro
      - wolf-logs:/srv/data/logs
    environment:
      - TZ=Europe/Warsaw
    depends_on:
      database:
        condition: service_healthy
    networks:
      - wolf-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7171"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  database:
    image: mariadb:10.11
    container_name: wolf-database
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-wolf_root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-wolf}
      MYSQL_USER: ${MYSQL_USER:-wolf}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-wolf_password}
    volumes:
      - wolf-db-data:/var/lib/mysql
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    ports:
      - "3306:3306"
    networks:
      - wolf-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: wolf-phpmyadmin
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      PMA_HOST: database
      PMA_USER: ${MYSQL_USER:-wolf}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-wolf_password}
    depends_on:
      database:
        condition: service_healthy
    networks:
      - wolf-network
    profiles:
      - admin

volumes:
  wolf-db-data:
    driver: local
  wolf-logs:
    driver: local

networks:
  wolf-network:
    driver: bridge
