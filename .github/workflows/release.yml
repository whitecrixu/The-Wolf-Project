name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libboost-iostreams-dev \
            libboost-system-dev \
            libgmp-dev \
            libluajit-5.1-dev \
            libmariadb-dev \
            libpugixml-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Package
        run: |
          mkdir -p release
          cp build/wolfserver release/
          cp -r data release/
          cp config.lua.dist release/
          cp schema.sql release/
          cp LICENSE release/
          cp README.md release/
          tar -czvf wolfserver-linux-x64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wolfserver-linux-x64
          path: wolfserver-linux-x64.tar.gz

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'a34c873a9717a888f58dc05571dde15571da8571'

      - name: Install dependencies via vcpkg
        run: |
          vcpkg install boost-iostreams:x64-windows boost-system:x64-windows gmp:x64-windows libmariadb:x64-windows luajit:x64-windows pugixml:x64-windows

      - name: Configure CMake
        run: cmake -B build -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          mkdir release
          copy build\Release\wolfserver.exe release\
          xcopy /E /I data release\data
          copy config.lua.dist release\
          copy schema.sql release\
          copy LICENSE release\
          copy README.md release\
          Compress-Archive -Path release\* -DestinationPath wolfserver-windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wolfserver-windows-x64
          path: wolfserver-windows-x64.zip

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: wolfserver-linux-x64

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: wolfserver-windows-x64

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wolfserver-linux-x64.tar.gz
            wolfserver-windows-x64.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
